name: check_tf_files

on:
  workflow_call:
    inputs:
      tf_fmt:
        required: false
        default: false
        type: boolean
      add_tf_fmt:
        required: false
        default: false
        type: boolean
      checkov:
        required: false
        default: false
        type: boolean
      tfsec:
        required: false
        default: false
        type: boolean

jobs:
    check_org:
      name: Check calling organization
      runs-on: ubuntu-latest

      steps:
        - name: Check the calling organization
          if: ${{ github.repository_owner != 'trafilea' }}
          uses: actions/github-script@v3
          with:
            script: |
              core.setFailed('This reusable workflow can only be used by Trafilea.')

    check_files:
      needs: check_org
      runs-on: ubuntu-latest
      name: Do checks on the terraform files
      steps:
        - name: Checkout code
          uses: actions/checkout@v3.1.0
          with:
           fetch-depth: 0
           ref: ${{ github.event.pull_request.head.ref }}

        - name: Execute 'terraform fmt'
          if: ${{ inputs.tf_fmt }}
          uses: dflook/terraform-fmt@v1
          with:
           path: .

        - name: Add & Commit 'terraform fmt' changes into PR
          uses: EndBug/add-and-commit@v9
          with:
            add: '.'
            message: 'Add formatted terraform files.'

        - name: Render terraform docs inside the README.md and push changes back to PR branch
          uses: terraform-docs/gh-actions@v1.0.0
          with:
            find-dir: .
            output-file: README.md
            output-method: inject
            git-push: "true"

        - name: Do checkov check on files
          if: ${{ inputs.checkov }}
          uses: bridgecrewio/checkov-action@master
          with:
            framework: terraform
            quiet: true

        - name: Do TFSec check on files
          if: ${{ inputs.tfsec }}
          uses: aquasecurity/tfsec-action@v1.0.0
